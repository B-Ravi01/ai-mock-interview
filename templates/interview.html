<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Session</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .feedback-content { white-space: pre-wrap; }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 md:p-8 min-h-screen flex flex-col items-center justify-center">

        <div id="interview-container" class="w-full">
            <!-- Question Display Area -->
            <div class="w-full max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg text-center mb-8">
                <p class="text-sm font-semibold text-indigo-600" id="question-counter">Question 1 of 10</p>
                <h2 class="text-2xl md:text-3xl font-bold mt-2" id="question-text">Loading your first question...</h2>
            </div>

            <!-- User Controls Area -->
            <div class="w-full max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg flex flex-col items-center">
                <p class="text-gray-600 mb-4" id="status-text">Click the microphone to start recording your answer.</p>

                <button id="record-button" class="w-20 h-20 bg-indigo-600 text-white rounded-full flex items-center justify-center text-3xl transition-all duration-300 ease-in-out hover:bg-indigo-700 focus:outline-none">
                    <i class="fas fa-microphone"></i>
                </button>

                <div class="mt-6 w-full bg-gray-50 p-4 rounded-lg min-h-[100px] border">
                    <p class="text-gray-700" id="answer-text"></p>
                </div>

                <button id="submit-answer-button" class="mt-6 w-full py-3 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-all duration-300 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Submit Answer
                </button>
            </div>
        </div>

        <!-- Feedback Display Area (Initially Hidden) -->
        <div id="feedback-container" class="w-full max-w-4xl bg-white p-8 md:p-12 rounded-2xl shadow-lg hidden">
            <h2 class="text-3xl font-bold text-center mb-6">Interview Feedback</h2>
            <div id="feedback-content" class="text-gray-700 leading-relaxed feedback-content"></div>
            <button onclick="window.location.href='/'" class="mt-8 w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-all">
                Start a New Interview
            </button>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const questionCounter = document.getElementById('question-counter');
        const questionText = document.getElementById('question-text');
        const statusText = document.getElementById('status-text');
        const recordButton = document.getElementById('record-button');
        const answerText = document.getElementById('answer-text');
        const submitButton = document.getElementById('submit-answer-button');
        const interviewContainer = document.getElementById('interview-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackContent = document.getElementById('feedback-content');

        // --- State Variables ---
        let questions = [];
        let interviewLog = [];
        let studentName = '';
        let currentQuestionIndex = 0;
        let isRecording = false;

        // --- Web Speech API Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true; // Keep listening even after a pause
            recognition.interimResults = true; // Get results as they are being spoken
            recognition.lang = 'en-US';
        } else {
            statusText.textContent = "Sorry, your browser does not support Speech Recognition. Please use Google Chrome or Edge.";
            recordButton.disabled = true;
        }

        // --- Initialization ---
        window.onload = () => {
            const storedQuestions = localStorage.getItem('interviewQuestions');
            studentName = localStorage.getItem('studentName') || 'the candidate';
            if (storedQuestions) {
                questions = JSON.parse(storedQuestions);
                displayQuestion();
            } else {
                questionText.textContent = "Could not load questions. Please start again.";
            }
        };

        // --- Core Functions ---
        function displayQuestion() {
            if (currentQuestionIndex < questions.length) {
                questionCounter.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
                const currentQuestion = questions[currentQuestionIndex];
                questionText.textContent = currentQuestion;
                speak(currentQuestion);
            } else {
                interviewContainer.innerHTML = `<div class="text-center p-8 bg-white rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold">Interview Complete!</h2>
                    <p class="mt-4 text-gray-600">You've answered all the questions. Click the button below to get your personalized feedback.</p>
                    <button id="get-feedback-button" class="mt-8 py-3 px-6 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700">Get My Feedback</button>
                </div>`;
                document.getElementById('get-feedback-button').addEventListener('click', handleGetFeedback);
            }
        }

        function speak(text) {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
        }

        function toggleRecording() {
            if (!recognition) return;
            isRecording ? recognition.stop() : recognition.start();
        }

        // --- Speech Recognition Event Handlers ---
        recognition.onstart = () => {
            isRecording = true;
            recordButton.classList.add('pulse', 'bg-red-600');
            statusText.textContent = "Listening... Click the microphone to stop.";
            answerText.textContent = "";
            submitButton.disabled = true;
        };

        recognition.onend = () => {
            isRecording = false;
            recordButton.classList.remove('pulse', 'bg-red-600');
            statusText.textContent = "Recording stopped. Click the microphone to record again.";
        };

        recognition.onerror = (event) => {
            console.error("Speech Recognition Error:", event.error);
            statusText.textContent = `Error: ${event.error}. Please try again.`;
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
            answerText.textContent = finalTranscript + interimTranscript;
            if (finalTranscript.trim().length > 0) {
                submitButton.disabled = false;
                statusText.textContent = "Transcription complete. You can now submit your answer.";
            }
        };

        // --- Button Event Handlers ---
        function handleSubmitAnswer() {
            const userAnswer = answerText.textContent;
            if (!userAnswer) return;

            interviewLog.push({ question: questions[currentQuestionIndex], answer: userAnswer });
            currentQuestionIndex++;
            displayQuestion();
            resetForNextQuestion();
        }

        async function handleGetFeedback() {
            const feedbackButton = document.getElementById('get-feedback-button');
            feedbackButton.disabled = true;
            feedbackButton.textContent = 'Analyzing your performance...';

            try {
                const response = await fetch('/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interviewData: interviewLog, studentName: studentName })
                });
                const result = await response.json();
                if (response.ok) {
                    feedbackContent.textContent = result.feedback;
                    interviewContainer.classList.add('hidden');
                    feedbackContainer.classList.remove('hidden');
                } else { throw new Error(result.error || 'Failed to get feedback.'); }
            } catch (error) {
                feedbackButton.textContent = 'Error getting feedback. Try again.';
                feedbackButton.disabled = false;
                console.error('Feedback Error:', error);
            }
        }

        function resetForNextQuestion() {
            submitButton.disabled = true;
            answerText.textContent = "";
            statusText.textContent = "Click the microphone to start recording your answer.";
        }

        recordButton.addEventListener('click', toggleRecording);
        submitButton.addEventListener('click', handleSubmitAnswer);
    </script>
</body>
</html>
